---
- name: Setup development environment on remote machine(s)
  hosts: all
  become: true

  vars:
    common_packages:
      - git
      - zsh
      - curl
      - wget
      - htop
      - net-tools
      - tmux
      - vim
      - python3
      - python3-pip
      - docker.io
      - docker-compose
      - openvpn
      - ufw
      - nmap
      - iperf

  tasks:
    # Install common packages
    - name: Install common packages
      apt:
        name: "{{ item }}"
        state: present
      loop: "{{ common_packages }}"
      when: ansible_facts['distribution'] == 'Ubuntu'

    # Install Node.js and npm
    - name: Install Node.js and npm
      apt:
        name: nodejs
        state: present
      when: ansible_facts['distribution'] == 'Ubuntu'

    - name: Install npm
      apt:
        name: npm
        state: present
      when: ansible_facts['distribution'] == 'Ubuntu'

    # Install Docker and enable the Docker service
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present
      when: ansible_facts['distribution'] == 'Ubuntu'

    - name: Add user to Docker group
      user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: yes
      when: ansible_facts['distribution'] == 'Ubuntu'

    - name: Enable and start Docker service
      service:
        name: docker
        enabled: yes
        state: started
      when: ansible_facts['distribution'] == 'Ubuntu'

    # Install Oh My Zsh
    - name: Install Oh My Zsh
      shell: |
        if [ ! -d "$HOME/.oh-my-zsh" ]; then
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)";
        fi
      args:
        executable: /bin/zsh

    # Install Powerlevel10k Zsh theme
    - name: Install Powerlevel10k Zsh theme
      git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: ~/.oh-my-zsh/custom/themes/powerlevel10k
      notify:
        - Update .zshrc for Powerlevel10k

    # Install Python virtualenv
    - name: Install Python virtualenv
      pip:
        name: virtualenv
      when: ansible_facts['distribution'] == 'Ubuntu'

    # Setup ufw firewall
    - name: Allow SSH through UFW
      ufw:
        rule: allow
        port: 22
        proto: tcp

    - name: Enable UFW
      ufw:
        state: enabled

  handlers:
    - name: Update .zshrc for Powerlevel10k
      shell: source ~/.zshrc
      args:
        executable: /bin/zsh

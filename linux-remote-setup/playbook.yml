---
- name: Setup remote Linux development environment
  hosts: all
  become: true

  vars:
    common_packages:
      - git
      - zsh
      - curl
      - wget
      - htop
      - tmux
      - vim
      - python3
      - python3-pip

  tasks:
    # Update package managers
    - name: Update apt cache (Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_facts['os_family'] == 'Debian'

    - name: Update dnf cache (Fedora)
      dnf:
        update_cache: yes
      when: ansible_facts['distribution'] == 'Fedora'

    # Install common packages
    - name: Install common packages (Debian/Ubuntu)
      apt:
        name: "{{ common_packages }}"
        state: present
      when: ansible_facts['os_family'] == 'Debian'

    - name: Install common packages (Fedora)
      dnf:
        name: "{{ common_packages }}"
        state: present
      when: ansible_facts['distribution'] == 'Fedora'

    # Install Node.js and npm
    - name: Install Node.js and npm (Debian/Ubuntu)
      apt:
        name: "{{ node_packages }}"
        state: present
      when: ansible_facts['os_family'] == 'Debian'

    - name: Install Node.js and npm (Fedora)
      dnf:
        name: "{{ node_packages }}"
        state: present
      when: ansible_facts['distribution'] == 'Fedora'

    # Install and configure Docker
    - name: Install Docker (Debian/Ubuntu)
      apt:
        name: docker.io
        state: present
      when: 
        - ansible_facts['os_family'] == 'Debian'
        - docker_settings.install

    - name: Install Docker (Fedora)
      dnf:
        name: docker
        state: present
      when: 
        - ansible_facts['distribution'] == 'Fedora'
        - docker_settings.install

    - name: Add user to Docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_settings.users_to_add_to_group }}"
      when: docker_settings.install

    - name: Enable and start Docker service
      service:
        name: docker
        enabled: yes
        state: started
      when: docker_settings.install

    # Install Oh My Zsh for remote user
    - name: Get remote user home directory
      shell: echo $HOME
      register: user_home
      become: false
      changed_when: false

    - name: Check if Oh My Zsh is installed
      stat:
        path: "{{ user_home.stdout }}/.oh-my-zsh"
      register: oh_my_zsh_installed
      become: false

    - name: Install Oh My Zsh
      shell: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
      args:
        creates: "{{ user_home.stdout }}/.oh-my-zsh"
      become: false
      when: 
        - not oh_my_zsh_installed.stat.exists
        - shell_settings.oh_my_zsh.install

    # Set Zsh as default shell
    - name: Set Zsh as the default shell
      user:
        name: "{{ ansible_user }}"
        shell: "{{ shell_settings.default_shell }}"
      when: shell_settings.oh_my_zsh.install

    # Install Powerlevel10k theme
    - name: Clone Powerlevel10k theme
      git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "{{ user_home.stdout }}/.oh-my-zsh/custom/themes/powerlevel10k"
        depth: 1
      become: false
      when: shell_settings.oh_my_zsh.install

    # Configure Zsh theme
    - name: Set Powerlevel10k as default Zsh theme
      lineinfile:
        path: "{{ user_home.stdout }}/.zshrc"
        regexp: '^ZSH_THEME=.*'
        line: 'ZSH_THEME="{{ shell_settings.oh_my_zsh.theme }}"'
        create: yes
      become: false
      when: shell_settings.oh_my_zsh.install

    # Install Python virtualenv
    - name: Install virtualenv via pip
      pip:
        name: virtualenv
        state: present
      become: false

    # Enhanced security setup for remote machines
    - name: Install UFW (Debian/Ubuntu)
      apt:
        name: ufw
        state: present
      when: 
        - ansible_facts['os_family'] == 'Debian'
        - security_settings.ufw_enabled

    - name: Install firewalld (Fedora)
      dnf:
        name: firewalld
        state: present
      when: 
        - ansible_facts['distribution'] == 'Fedora'
        - security_settings.ufw_enabled

    - name: Configure UFW (Debian/Ubuntu)
      block:
        - name: Allow SSH through UFW
          ufw:
            rule: allow
            port: 22
            proto: tcp
        - name: Enable UFW
          ufw:
            state: enabled
      when: 
        - ansible_facts['os_family'] == 'Debian'
        - security_settings.ufw_enabled

    - name: Configure firewalld (Fedora)
      block:
        - name: Start and enable firewalld
          service:
            name: firewalld
            state: started
            enabled: yes
        - name: Allow SSH through firewalld
          firewalld:
            service: ssh
            permanent: yes
            state: enabled
      when: 
        - ansible_facts['distribution'] == 'Fedora'
        - security_settings.ufw_enabled

    # Configure SSH security
    - name: Configure SSH for security
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^PermitRootLogin', line: 'PermitRootLogin {{ "yes" if security_settings.ssh_settings.permit_root_login else "no" }}' }
        - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication {{ "yes" if security_settings.ssh_settings.password_authentication else "no" }}' }
        - { regexp: '^PubkeyAuthentication', line: 'PubkeyAuthentication {{ "yes" if security_settings.ssh_settings.pubkey_authentication else "no" }}' }
      notify: Restart SSH

  handlers:
    - name: Restart SSH
      service:
        name: sshd
        state: restarted 